#!/usr/bin/env bash
set -e

[ -f test-result.txt ] || (echo "No test-result to vote on" >&2; exit 1)
vote="0"
head -1 test-result.txt | grep -q "^PASSED" && vote="+1"
head -1 test-result.txt | grep -q "^FAILED" && vote="-1"

uuid=$(basename $(pwd))
date=$(date "+%F %T")
url=$(cat event.json | sed -z -e 's/.*"url": "//' -e 's/".*//')
commit=$(cat event.json | sed -z -e 's/.*"revision": "//' -e 's/".*//')
echo "${date} ${uuid} VOTE   ${vote} ${url}"
ssh -p 29418 ${CI_SSH_OPTS} ${CI_SSH_USER?}@review.openstack.org \
  gerrit review --code-review "${vote}" --message \'"$(cat test-result.txt)"\' \
  ${commit}  && (echo ${vote}    >> cast-votes.txt)
#touch cast-votes.txt

